// tests/unit/test-analyze.naab - Unit tests for analyzer module
use io
use json
use string
use array

// Add parent directory to module search path
use ../analyze

main {
    io.write("[TEST] Analyzer Module Unit Tests\n\n")

    let pass_count = 0
    let fail_count = 0

    // Test 1: Python file detection
    io.write("Test 1: Python file detection... ")
    try {
        let result = analyze.analyze_file("tests/fixtures/python/slow_loops.py")

        if result["status"] == "ANALYZED" && result["source"] == "PYTHON" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected PYTHON source\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 2: Function extraction
    io.write("Test 2: Function extraction... ")
    try {
        let result = analyze.analyze_file("tests/fixtures/python/slow_loops.py")
        let func_count = array.length(result["functions"])

        if func_count == 3 {  // heavy_computation, simple_function, crypto_hash
            io.write("✓ PASS (", func_count, " functions)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected 3 functions, got ", func_count, "\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 3: Complexity calculation
    io.write("Test 3: Complexity calculation... ")
    try {
        let result = analyze.analyze_file("tests/fixtures/python/slow_loops.py")
        let heavy_func = result["functions"][0]

        if heavy_func["complexity"] > 1 {  // Should detect nested loops
            io.write("✓ PASS (complexity: ", heavy_func["complexity"], ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected complexity > 1\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 4: Target language recommendation
    io.write("Test 4: Target recommendation for crypto... ")
    try {
        let result = analyze.analyze_file("tests/fixtures/python/slow_loops.py")
        let crypto_func = result["functions"][2]  // crypto_hash function

        if crypto_func["target"] == "RUST" {
            io.write("✓ PASS (recommended: ", crypto_func["target"], ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected RUST for crypto, got ", crypto_func["target"], "\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 5: Unsupported file type
    io.write("Test 5: Unsupported file type error... ")
    try {
        // Create a dummy unsupported file
        use file
        file.write("tests/fixtures/unknown.txt", "Not a code file")

        let result = analyze.analyze_file("tests/fixtures/unknown.txt")

        if result["error"] == "UNSUPPORTED_LANGUAGE" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected UNSUPPORTED_LANGUAGE error\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Summary
    io.write("\n═══════════════════════════════════════\n")
    io.write("Total: ", (pass_count + fail_count), " | Pass: ", pass_count, " | Fail: ", fail_count, "\n")
    io.write("═══════════════════════════════════════\n")

    if fail_count > 0 {
        throw "Tests failed"
    }
}
