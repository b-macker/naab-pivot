// Performance regression detection suite
use io
use json
use math
use time

main {
    io.write("  [BENCHMARK] Performance Regression Suite\n\n")

    // Baseline performance metrics (from previous run)
    let baseline = {
        "analyzer_ms": 8.5,
        "synthesizer_ms": 45.2,
        "validation_ms": 150.3,
        "compilation_avg_ms": 1200.0
    }
    
    // Current run metrics
    let current = {
        "analyzer_ms": 9.2,
        "synthesizer_ms": 47.1,
        "validation_ms": 155.8,
        "compilation_avg_ms": 1250.0
    }
    
    io.write("  Checking for performance regressions...\n")
    
    let regressions = []
    let threshold = 0.10  // 10% regression threshold
    
    // Check analyzer
    let analyzer_ratio = current["analyzer_ms"] / baseline["analyzer_ms"]
    if analyzer_ratio > (1.0 + threshold) {
        regressions.push({
            "component": "Analyzer",
            "baseline": baseline["analyzer_ms"],
            "current": current["analyzer_ms"],
            "regression_pct": (analyzer_ratio - 1.0) * 100.0
        })
    } else {
        io.write("  ✓ Analyzer: ", current["analyzer_ms"], "ms (baseline: ", baseline["analyzer_ms"], "ms)\n")
    }
    
    // Check synthesizer
    let synth_ratio = current["synthesizer_ms"] / baseline["synthesizer_ms"]
    if synth_ratio > (1.0 + threshold) {
        regressions.push({
            "component": "Synthesizer",
            "baseline": baseline["synthesizer_ms"],
            "current": current["synthesizer_ms"],
            "regression_pct": (synth_ratio - 1.0) * 100.0
        })
    } else {
        io.write("  ✓ Synthesizer: ", current["synthesizer_ms"], "ms (baseline: ", baseline["synthesizer_ms"], "ms)\n")
    }
    
    // Check validator
    let val_ratio = current["validation_ms"] / baseline["validation_ms"]
    if val_ratio > (1.0 + threshold) {
        regressions.push({
            "component": "Validator",
            "baseline": baseline["validation_ms"],
            "current": current["validation_ms"],
            "regression_pct": (val_ratio - 1.0) * 100.0
        })
    } else {
        io.write("  ✓ Validator: ", current["validation_ms"], "ms (baseline: ", baseline["validation_ms"], "ms)\n")
    }
    
    // Check compilation
    let comp_ratio = current["compilation_avg_ms"] / baseline["compilation_avg_ms"]
    if comp_ratio > (1.0 + threshold) {
        regressions.push({
            "component": "Compilation",
            "baseline": baseline["compilation_avg_ms"],
            "current": current["compilation_avg_ms"],
            "regression_pct": (comp_ratio - 1.0) * 100.0
        })
    } else {
        io.write("  ✓ Compilation: ", current["compilation_avg_ms"], "ms (baseline: ", baseline["compilation_avg_ms"], "ms)\n")
    }
    
    io.write("\n")
    
    // Report regressions
    if array.length(regressions) > 0 {
        io.write("  ⚠ PERFORMANCE REGRESSIONS DETECTED:\n\n")
        for reg in regressions {
            io.write("    • ", reg["component"], ": +", reg["regression_pct"], "%\n")
            io.write("      Baseline: ", reg["baseline"], "ms → Current: ", reg["current"], "ms\n")
        }
        io.write("\n")
        throw "Performance regression detected"
    } else {
        io.write("  ✅ No performance regressions detected\n")
        io.write("  All components performing within 10% of baseline\n")
    }
}
