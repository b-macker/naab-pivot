// tests/unit/test-config.naab - Unit tests for config management
use io
use json
use file

// Add parent modules to search path
use ../modules/config_manager

main {
    io.write("[TEST] Config Manager Unit Tests\n\n")

    let pass_count = 0
    let fail_count = 0

    // Test 1: Default config loading
    io.write("Test 1: Default config values... ")
    try {
        let config = config_manager.load_config({})

        if config["profile"] == "balanced" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected 'balanced' profile\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 2: Environment variable override
    io.write("Test 2: Environment variable override... ")
    try {
        use env
        env.set_var("PIVOT_PROFILE", "aggressive")

        let config = config_manager.load_config({})

        if config["profile"] == "aggressive" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected 'aggressive' from env\n")
            fail_count = fail_count + 1
        }

        // Cleanup
        env.set_var("PIVOT_PROFILE", "")
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 3: Config file loading
    io.write("Test 3: Project config file loading... ")
    try {
        // Create test config file
        let test_config = {
            "profile": "conservative",
            "output": "./test-vessels",
            "validate": true
        }

        file.write("tests/.pivotrc", json.stringify(test_config, true))

        let config = config_manager.load_project_config("tests")

        if config["profile"] == "conservative" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - Expected 'conservative' from file\n")
            fail_count = fail_count + 1
        }

        // Cleanup
        <<bash rm -f tests/.pivotrc >>
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Test 4: Merge priority (CLI > env > file > defaults)
    io.write("Test 4: Config merge priority... ")
    try {
        use env
        env.set_var("PIVOT_PROFILE", "balanced")

        let cli_args = {"profile": "aggressive"}
        let config = config_manager.load_config(cli_args)

        if config["profile"] == "aggressive" {
            io.write("✓ PASS (CLI overrides env)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL - CLI should override env\n")
            fail_count = fail_count + 1
        }

        env.set_var("PIVOT_PROFILE", "")
    } catch (e) {
        io.write("✗ FAIL - Exception: ", e, "\n")
        fail_count = fail_count + 1
    }

    // Summary
    io.write("\n═══════════════════════════════════════\n")
    io.write("Total: ", (pass_count + fail_count), " | Pass: ", pass_count, " | Fail: ", fail_count, "\n")
    io.write("═══════════════════════════════════════\n")

    if fail_count > 0 {
        throw "Tests failed"
    }
}
