// tests/performance/bench-analyzer.naab - Analyzer performance benchmark
use io
use time
use array

use ../analyze

main {
    io.write("[BENCHMARK] Analyzer Performance Test\n\n")

    let iterations = 10
    let timings = []

    io.write("Running ", iterations, " iterations...\n\n")

    // Benchmark Python analysis
    for i in 0..iterations {
        let start = time.now()

        try {
            let result = analyze.analyze_file("tests/fixtures/python/slow_loops.py")
            let elapsed = time.now() - start

            timings = array.push(timings, elapsed)

            io.write("  Iteration ", i + 1, ": ", elapsed, "ms\n")
        } catch (e) {
            io.write("  Iteration ", i + 1, ": ERROR - ", e, "\n")
        }
    }

    // Calculate statistics
    let sum = 0.0
    let min_time = timings[0]
    let max_time = timings[0]

    for timing in timings {
        sum = sum + timing

        if timing < min_time {
            min_time = timing
        }

        if timing > max_time {
            max_time = timing
        }
    }

    let mean = sum / (1.0 * array.length(timings))

    // Calculate standard deviation
    let variance_sum = 0.0
    for timing in timings {
        let dev = timing - mean
        variance_sum = variance_sum + (dev * dev)
    }

    let variance = variance_sum / (1.0 * array.length(timings))
    let stddev = sqrt(variance)

    // Results
    io.write("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
    io.write("Analyzer Performance Results\n")
    io.write("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
    io.write("Iterations: ", iterations, "\n")
    io.write("Mean: ", mean, "ms\n")
    io.write("Min: ", min_time, "ms\n")
    io.write("Max: ", max_time, "ms\n")
    io.write("Std Dev: ", stddev, "ms\n")
    io.write("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

    // Performance threshold check
    if mean > 5000.0 {
        io.write("âš  WARNING: Analyzer is slower than 5s threshold\n")
    } else if mean > 1000.0 {
        io.write("âš  NOTICE: Analyzer took >1s (acceptable)\n")
    } else {
        io.write("âœ“ PASS: Analyzer performance acceptable\n")
    }

    // Save benchmark results
    use json
    use file

    let results = {
        "benchmark": "analyzer",
        "iterations": iterations,
        "mean_ms": mean,
        "min_ms": min_time,
        "max_ms": max_time,
        "stddev_ms": stddev,
        "timings": timings
    }

    file.write("tests/results/bench-analyzer.json", json.stringify(results, true))
    io.write("\nðŸ“Š Results saved to tests/results/bench-analyzer.json\n")
}

fn sqrt(x) {
    // Newton-Raphson square root
    if x <= 0 {
        return 0
    }

    let guess = x / 2.0
    let epsilon = 0.0001

    for i in 0..20 {
        let new_guess = (guess + x / guess) / 2.0

        if abs(new_guess - guess) < epsilon {
            return new_guess
        }

        guess = new_guess
    }

    return guess
}

fn abs(x) {
    if x < 0 {
        return -x
    }
    return x
}
