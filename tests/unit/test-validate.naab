// Unit tests for validate.naab module
use io
use json
use array
use math

main {
    io.write("  [TEST] Validator Unit Tests\n")

    let pass_count = 0
    let fail_count = 0

    // Test 1: Parity certification (identical results)
    try {
        io.write("    Test 1: Identical results certification... ")
        
        let legacy_results = [100.0, 200.0, 300.0]
        let vessel_results = [100.0, 200.0, 300.0]
        
        let certified = true
        let threshold = 0.001
        
        for i in 0..array.length(legacy_results) {
            let diff = math.abs(legacy_results[i] - vessel_results[i])
            if diff > threshold {
                certified = false
            }
        }
        
        if certified == true {
            io.write("✓ PASS (certified)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (not certified)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 2: Relative error calculation
    try {
        io.write("    Test 2: Relative error calculation... ")
        
        let legacy_val = 1000.0
        let vessel_val = 1000.1
        let rel_err = math.abs(vessel_val - legacy_val) / legacy_val
        
        if rel_err < 0.001 {
            io.write("✓ PASS (rel_err: ", rel_err, ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (rel_err too high: ", rel_err, ")\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 3: Statistical summary
    try {
        io.write("    Test 3: Statistical analysis... ")
        
        let differences = [0.001, 0.002, 0.0015, 0.0008, 0.0012]
        let sum = 0.0
        
        for diff in differences {
            sum = sum + diff
        }
        
        let mean = sum / (1.0 * array.length(differences))
        
        if mean < 0.01 {
            io.write("✓ PASS (mean: ", mean, ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (mean too high)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 4: Performance speedup calculation
    try {
        io.write("    Test 4: Speedup calculation... ")
        
        let legacy_ms = 2843.0
        let vessel_ms = 812.0
        let speedup = legacy_ms / vessel_ms
        
        if speedup > 3.0 {
            io.write("✓ PASS (", speedup, "x speedup)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (speedup < 3x)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 5: Test case count validation
    try {
        io.write("    Test 5: Test case count... ")
        
        let test_cases = []
        for i in 0..100 {
            test_cases.push(i)
        }
        
        if array.length(test_cases) >= 100 {
            io.write("✓ PASS (", array.length(test_cases), " cases)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (insufficient test cases)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Summary
    io.write("\n  ═══════════════════════════════════════════════\n")
    io.write("  Total: ", (pass_count + fail_count), " | Pass: ", pass_count, " | Fail: ", fail_count, "\n")
    io.write("  ═══════════════════════════════════════════════\n")

    if fail_count > 0 {
        throw "Tests failed"
    }
}
