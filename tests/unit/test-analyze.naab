// Unit tests for analyze.naab module
use io
use json
use file
use array

main {
    io.write("  [TEST] Analyzer Unit Tests\n")

    let pass_count = 0
    let fail_count = 0
    let fixtures_dir = "tests/fixtures"

    // Test 1: Python file detection
    try {
        io.write("    Test 1: Python file detection... ")
        
        // Simulate analyzer response for Python file
        let result = {
            "status": "ANALYZED",
            "source": "PYTHON",
            "functions": [
                {
                    "name": "heavy_computation",
                    "line_start": 4,
                    "line_count": 5,
                    "complexity": 3,
                    "has_loops": true,
                    "target": "GO",
                    "reason": "High complexity or loops detected"
                }
            ]
        }
        
        if result["source"] == "PYTHON" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (expected PYTHON, got ", result["source"], ")\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 2: Function extraction
    try {
        io.write("    Test 2: Function extraction... ")
        
        let result = {
            "functions": [
                {"name": "heavy_computation", "complexity": 3},
                {"name": "nested_loops", "complexity": 5},
                {"name": "factorial", "complexity": 2}
            ]
        }
        
        let func_count = array.length(result["functions"])
        if func_count >= 3 {
            io.write("✓ PASS (", func_count, " functions)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (expected >=3, got ", func_count, ")\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 3: Complexity calculation
    try {
        io.write("    Test 3: Complexity calculation... ")
        
        let func = {
            "name": "nested_loops",
            "complexity": 5,
            "has_loops": true
        }
        
        if func["complexity"] > 0 {
            io.write("✓ PASS (complexity: ", func["complexity"], ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (invalid complexity)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 4: Target language recommendation
    try {
        io.write("    Test 4: Target recommendation... ")
        
        let func = {
            "name": "heavy_computation",
            "complexity": 8,
            "has_loops": true,
            "target": "GO",
            "reason": "High complexity with loops"
        }
        
        let target = func["target"]
        if target == "GO" || target == "CPP" || target == "RUST" {
            io.write("✓ PASS (target: ", target, ")\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (invalid target: ", target, ")\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 5: Unsupported language handling
    try {
        io.write("    Test 5: Unsupported language error... ")
        
        let result = {
            "error": "UNSUPPORTED_LANGUAGE",
            "ext": "txt"
        }
        
        if result["error"] == "UNSUPPORTED_LANGUAGE" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (expected error)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 6: Hotspot detection (high complexity functions)
    try {
        io.write("    Test 6: Hotspot detection... ")
        
        let functions = [
            {"name": "func_a", "complexity": 2},
            {"name": "func_b", "complexity": 15},
            {"name": "func_c", "complexity": 3}
        ]
        
        let hotspots = []
        for func in functions {
            if func["complexity"] > 10 {
                hotspots.push(func)
            }
        }
        
        if array.length(hotspots) == 1 {
            io.write("✓ PASS (1 hotspot detected)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (expected 1 hotspot)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 7: Loop detection
    try {
        io.write("    Test 7: Loop detection... ")
        
        let func = {
            "name": "nested_loops",
            "has_loops": true
        }
        
        if func["has_loops"] == true {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (loops not detected)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 8: Multiple language detection
    try {
        io.write("    Test 8: Multi-language support... ")
        
        let languages = ["PYTHON", "RUBY", "JAVASCRIPT", "NAAB"]
        let supported = true
        
        for lang in languages {
            if lang == "" {
                supported = false
            }
        }
        
        if supported == true {
            io.write("✓ PASS (", array.length(languages), " languages)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Summary
    io.write("\n  ═══════════════════════════════════════════════\n")
    io.write("  Total: ", (pass_count + fail_count), " | Pass: ", pass_count, " | Fail: ", fail_count, "\n")
    io.write("  ═══════════════════════════════════════════════\n")

    if fail_count > 0 {
        throw "Tests failed"
    }
}
