// dashboard/serve.naab - Dashboard HTTP server
use io
use json
use file
use env
use string

main {
    io.write("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
    io.write("â•‘        NAAb Pivot Dashboard - Starting Server...         â•‘\n")
    io.write("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

    let port = env.get_var("PIVOT_DASHBOARD_PORT") || "8080"
    let host = env.get_var("PIVOT_DASHBOARD_HOST") || "0.0.0.0"

    io.write("  ğŸ“Š Dashboard URL: http://localhost:", port, "\n")
    io.write("  ğŸš€ Press Ctrl+C to stop\n\n")

    // Start simple HTTP server using Python
    let server_code = "
import http.server
import socketserver
import json
import os
from pathlib import Path

PORT = " + port + "

class DashboardHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/' or self.path == '/index.html':
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            with open('dashboard/static/index.html', 'rb') as f:
                self.wfile.write(f.read())
        elif self.path.startswith('/static/'):
            file_path = 'dashboard' + self.path
            if os.path.exists(file_path):
                if file_path.endswith('.css'):
                    content_type = 'text/css'
                elif file_path.endswith('.js'):
                    content_type = 'application/javascript'
                elif file_path.endswith('.html'):
                    content_type = 'text/html'
                else:
                    content_type = 'text/plain'

                self.send_response(200)
                self.send_header('Content-type', content_type)
                self.end_headers()
                with open(file_path, 'rb') as f:
                    self.wfile.write(f.read())
            else:
                self.send_error(404, 'File not found')
        elif self.path == '/api/projects':
            self.serve_api('dashboard/api/projects_data.json')
        elif self.path == '/api/benchmarks':
            self.serve_api('dashboard/api/benchmarks_data.json')
        elif self.path == '/api/vessels':
            self.serve_api('dashboard/api/vessels_data.json')
        else:
            self.send_error(404, 'Not Found')

    def serve_api(self, json_file):
        if os.path.exists(json_file):
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            with open(json_file, 'rb') as f:
                self.wfile.write(f.read())
        else:
            # Return empty data if file doesn't exist
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            self.wfile.write(b'{\"data\": []}')

    def log_message(self, format, *args):
        # Suppress default logging
        pass

with socketserver.TCPServer(('', PORT), DashboardHandler) as httpd:
    print(f'Dashboard serving at http://localhost:{PORT}')
    httpd.serve_forever()
"

    // Write server script
    file.write("/tmp/naab_dashboard_server.py", server_code)

    // Start server
    <<python
import subprocess
subprocess.run(['python3', '/tmp/naab_dashboard_server.py'])
    >>
}
