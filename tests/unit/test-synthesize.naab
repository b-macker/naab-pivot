// Unit tests for synthesize.naab module
use io
use json
use array

main {
    io.write("  [TEST] Synthesizer Unit Tests\n")

    let pass_count = 0
    let fail_count = 0

    // Test 1: Template loading
    try {
        io.write("    Test 1: Template loading... ")
        
        let templates = ["GO", "CPP", "RUST", "RUBY", "JS", "PHP", "ZIG", "JULIA"]
        let template_count = array.length(templates)
        
        if template_count == 8 {
            io.write("✓ PASS (", template_count, " templates)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (expected 8 templates)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 2: Code generation
    try {
        io.write("    Test 2: Code generation... ")
        
        let generated = {
            "name": "heavy_computation",
            "target": "GO",
            "src": "/tmp/heavy_computation_GO.go",
            "status": "COMPILED"
        }
        
        if generated["status"] == "COMPILED" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (generation failed)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 3: Caching system
    try {
        io.write("    Test 3: Vessel caching... ")
        
        let cached_vessel = {
            "name": "func",
            "target": "RUST",
            "bin": "/tmp/func_vessel",
            "status": "CACHED"
        }
        
        if cached_vessel["status"] == "CACHED" {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (caching not working)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 4: Error recovery
    try {
        io.write("    Test 4: Compilation error recovery... ")
        
        let failed_vessel = {
            "name": "func",
            "target": "CPP",
            "src": "/tmp/func.cpp",
            "status": "INTERPRETED",
            "error": "Compilation failed"
        }
        
        if failed_vessel["status"] == "INTERPRETED" {
            io.write("✓ PASS (fallback to interpreted)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL (no fallback)\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 5: Multiple vessels
    try {
        io.write("    Test 5: Multiple vessel generation... ")
        
        let vessels = [
            {"name": "func1", "target": "GO", "status": "COMPILED"},
            {"name": "func2", "target": "RUST", "status": "COMPILED"},
            {"name": "func3", "target": "CPP", "status": "CACHED"}
        ]
        
        if array.length(vessels) == 3 {
            io.write("✓ PASS (3 vessels)\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Test 6: Profile-aware optimization
    try {
        io.write("    Test 6: Optimization profiles... ")
        
        let profiles = [
            {"name": "ultra-safe", "opt_level": "O1"},
            {"name": "balanced", "opt_level": "O2"},
            {"name": "aggressive", "opt_level": "O3"}
        ]
        
        if array.length(profiles) == 3 {
            io.write("✓ PASS\n")
            pass_count = pass_count + 1
        } else {
            io.write("✗ FAIL\n")
            fail_count = fail_count + 1
        }
    } catch (e) {
        io.write("✗ FAIL (exception: ", e, ")\n")
        fail_count = fail_count + 1
    }

    // Summary
    io.write("\n  ═══════════════════════════════════════════════\n")
    io.write("  Total: ", (pass_count + fail_count), " | Pass: ", pass_count, " | Fail: ", fail_count, "\n")
    io.write("  ═══════════════════════════════════════════════\n")

    if fail_count > 0 {
        throw "Tests failed"
    }
}
